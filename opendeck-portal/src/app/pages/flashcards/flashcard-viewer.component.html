<div class="flashcard-viewer-container min-h-screen bg-surface-50 dark:bg-surface-950 py-8 px-4">
    <div class="max-w-5xl mx-auto">
        <!-- Header Section -->
        <div class="header-section mb-6">
            <div class="flex justify-between items-start mb-4">
                <p-button
                    [label]="'deck.backToDecks' | translate"
                    icon="pi pi-chevron-left"
                    [text]="true"
                    severity="secondary"
                    (onClick)="backToDecks()"
                    [attr.aria-label]="'Navigate back to deck listing'"
                />

                @if (!loadingInitial() && totalCards() > 0) {
                    <p-button
                        [label]="'flashcard.resetProgress' | translate"
                        icon="pi pi-refresh"
                        [text]="true"
                        severity="secondary"
                        (onClick)="resetProgress()"
                        [attr.aria-label]="'Reset progress and start from beginning'"
                    />
                }
            </div>

            @if (!loadingInitial()) {
                <h1 class="text-3xl font-semibold text-surface-900 dark:text-surface-0 mb-2">{{ deckTitle() }}</h1>
                @if (totalCards() > 0) {
                    <p class="text-surface-600 dark:text-surface-400 text-lg">{{ cardCountText() }}</p>
                }
            }
        </div>

        <!-- Resume Progress Message -->
        @if (resumedFromProgress() && !loadingInitial()) {
            <div class="mb-6">
                <p-message
                    severity="info"
                    [closable]="true"
                    styleClass="w-full"
                    (onClose)="resumedFromProgress.set(false)"
                >
                    <ng-template pTemplate="content">
                        <div class="flex items-center gap-2">
                            <i class="pi pi-bookmark text-lg"></i>
                            <span>{{ 'flashcard.resumedFromProgress' | translate: {current: globalCardIndex() + 1, total: totalCards()} }}</span>
                        </div>
                    </ng-template>
                </p-message>
            </div>
        }

        <!-- Page Loading Message -->
        @if (loadingPage() && !loadingInitial()) {
            <div class="mb-4">
                <p-message severity="info" styleClass="w-full">
                    <ng-template pTemplate="content">
                        <div class="flex items-center gap-2">
                            <i class="pi pi-spin pi-spinner text-lg"></i>
                            <span>{{ 'flashcard.loadingPage' | translate }}</span>
                        </div>
                    </ng-template>
                </p-message>
            </div>
        }

        <!-- Loading State -->
        @if (loadingInitial()) {
            <div class="flex flex-col items-center justify-center py-16">
                <p-progressSpinner
                    styleClass="w-16 h-16"
                    strokeWidth="4"
                    [attr.aria-label]="'Loading flashcards'"
                />
                <p class="mt-4 text-surface-600 dark:text-surface-400">{{ 'common.loading' | translate }}</p>
            </div>
        }

        <!-- Error State -->
        @if (error() && !loadingInitial()) {
            <div class="mb-6">
                <p-message
                    severity="error"
                    [text]="error()!"
                    styleClass="w-full"
                />
            </div>
        }

        <!-- Content (only show when not loading and no error) -->
        @if (!loadingInitial() && !error() && cards().length > 0) {

        <!-- Progress Bar -->
        <div class="mb-8">
            <p-progressBar
                [value]="progress()"
                [showValue]="false"
                class="custom-progress-bar"
                [attr.aria-label]="'Progress through flashcard deck'"
            />
        </div>

        <!-- Flashcard Container -->
        <div class="flashcard-wrapper mb-8" [@cardSlide]="animationTrigger()">
            @if (currentCard(); as card) {
                <p-card class="flashcard-main">
                    <div class="flashcard-content">
                        <!-- Question Section -->
                        <div class="question-section">
                            <p-tag
                                [value]="'flashcard.question' | translate"
                                severity="info"
                                class="mb-4"
                                [rounded]="true"
                            />
                            <p class="question-text text-2xl text-surface-900 dark:text-surface-0 leading-relaxed">
                                {{ card.question }}
                            </p>
                        </div>

                        <!-- Answer Section (conditionally shown) -->
                        @if (showAnswer()) {
                            <div class="answer-section" [@fadeIn]>
                                <div class="divider"></div>

                                <p-tag
                                    [value]="'flashcard.answer' | translate"
                                    severity="success"
                                    class="mb-4"
                                    [rounded]="true"
                                />

                                <p class="answer-text text-lg text-surface-700 dark:text-surface-200 leading-relaxed mb-6">
                                    {{ card.answer }}
                                </p>

                                <!-- Source Attribution Box - CRITICAL for OpenDeck -->
                                <div class="source-attribution-box bg-surface-100 dark:bg-surface-800 border border-surface-200 dark:border-surface-700 rounded-lg p-4">
                                    <div class="source-content">
                                        <div class="flex items-start gap-3">
                                            <i class="pi pi-file-pdf text-xl text-primary"></i>
                                            <div class="flex-1">
                                                <p class="source-label text-xs font-semibold text-surface-500 dark:text-surface-400 uppercase mb-1">
                                                    {{ 'flashcard.sourceReference' | translate }}
                                                </p>
                                                <p class="source-text text-sm text-surface-700 dark:text-surface-200">
                                                    {{ card.source || ('flashcard.sourceNotAvailable' | translate) }}
                                                </p>
                                            </div>
                                            @if (card.source_url && card.source_url !== '#') {
                                                <button
                                                    class="source-link-btn"
                                                    (click)="openSource(card.source_url)"
                                                    [attr.aria-label]="'Open source document'"
                                                >
                                                    <i class="pi pi-external-link"></i>
                                                </button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- Show Answer Button (shown when answer is hidden) -->
                        @if (!showAnswer()) {
                            <div class="show-answer-section">
                                <p-button
                                    [label]="'flashcard.showAnswer' | translate"
                                    icon="pi pi-eye"
                                    (onClick)="toggleAnswer()"
                                    severity="info"
                                    [raised]="true"
                                    class="show-answer-btn"
                                    [attr.aria-label]="'Reveal answer for current flashcard'"
                                />
                            </div>
                        }
                    </div>
                </p-card>
            }
        </div>

        <!-- Navigation Controls -->
        <div class="navigation-controls flex items-center justify-between">
            <!-- Previous Button -->
            <p-button
                [label]="'flashcard.previous' | translate"
                icon="pi pi-chevron-left"
                (onClick)="previousCard()"
                [disabled]="isFirstCard() || loadingPage()"
                severity="secondary"
                [outlined]="true"
                class="nav-btn"
                [attr.aria-label]="'Navigate to previous flashcard'"
            />

            <!-- Card Counter -->
            <div class="card-counter text-surface-600 dark:text-surface-300 text-base font-medium">
                {{ globalCardIndex() + 1 }} / {{ totalCards() }}
                <span class="text-sm text-surface-400 dark:text-surface-500 ml-2">
                    ({{ 'flashcard.page' | translate }} {{ currentPage() + 1 }}/{{ totalPages() }})
                </span>
            </div>

            <!-- Next Button -->
            <p-button
                [label]="'flashcard.next' | translate"
                icon="pi pi-chevron-right"
                iconPos="right"
                (onClick)="nextCard()"
                [disabled]="isLastCard() || loadingPage()"
                severity="secondary"
                [outlined]="true"
                class="nav-btn"
                [attr.aria-label]="'Navigate to next flashcard'"
            />
        </div>

        <!-- Keyboard Shortcuts Hint -->
        <div class="keyboard-hints text-center mt-8 text-surface-500 dark:text-surface-400 text-sm">
            <p>
                <span class="inline-flex items-center gap-1">
                    <kbd class="keyboard-key bg-surface-200 dark:bg-surface-700 border border-surface-300 dark:border-surface-600 text-surface-700 dark:text-surface-200">←</kbd>
                    <span>{{ 'flashcard.previous' | translate }}</span>
                </span>
                <span class="mx-4">|</span>
                <span class="inline-flex items-center gap-1">
                    <kbd class="keyboard-key bg-surface-200 dark:bg-surface-700 border border-surface-300 dark:border-surface-600 text-surface-700 dark:text-surface-200">→</kbd>
                    <span>{{ 'flashcard.next' | translate }}</span>
                </span>
                <span class="mx-4">|</span>
                <span class="inline-flex items-center gap-1">
                    <kbd class="keyboard-key bg-surface-200 dark:bg-surface-700 border border-surface-300 dark:border-surface-600 text-surface-700 dark:text-surface-200">Space</kbd>
                    <span>{{ 'flashcard.toggleAnswer' | translate }}</span>
                </span>
                <span class="mx-4">|</span>
                <span class="inline-flex items-center gap-1">
                    <kbd class="keyboard-key bg-surface-200 dark:bg-surface-700 border border-surface-300 dark:border-surface-600 text-surface-700 dark:text-surface-200">Esc</kbd>
                    <span>{{ 'deck.backToDecks' | translate }}</span>
                </span>
            </p>
        </div>
        } <!-- End of !loading() && !error() && cards().length > 0 condition -->
    </div>
</div>
