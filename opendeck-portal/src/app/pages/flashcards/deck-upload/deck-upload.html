<div class="deck-upload-container">
  <!-- Header -->
  <div class="upload-header">
    <h1 class="upload-title">
      <i class="pi pi-cloud-upload"></i>
      Create New Deck from Documents
    </h1>
    <p class="upload-subtitle">
      Upload your course materials and let AI generate flashcards automatically
    </p>
  </div>

  <!-- Main Upload Form - Only show if not uploading and not successful -->
  <div class="upload-content" *ngIf="!uploadSuccess() && !isUploading()">
    <form [formGroup]="uploadForm" (ngSubmit)="onSubmit()">
      <div class="grid">
        <!-- Left Column - File Upload -->
        <div class="col-12 lg:col-6">
          <p-card header="Documents" [style]="{'height': '100%'}">
            <div class="file-upload-section">
              <p-fileUpload
                #fileUpload
                name="files"
                [multiple]="true"
                [accept]="ACCEPTED_FILE_TYPES"
                [maxFileSize]="MAX_FILE_SIZE"
                [showUploadButton]="false"
                [showCancelButton]="false"
                [auto]="false"
                chooseLabel="Choose Files"
                chooseIcon="pi pi-file"
                (onSelect)="onFileSelect($event)"
                [disabled]="isUploading()"
              >
                <ng-template pTemplate="content" let-files>
                  <div class="file-upload-info" *ngIf="selectedFiles().length === 0">
                    <i class="pi pi-cloud-upload upload-icon"></i>
                    <p class="upload-text">Drag and drop files here or click to browse</p>
                    <p class="upload-hint">
                      Supported formats: PDF, DOCX, PPTX, TXT<br>
                      Max {{ MAX_FILES }} files, {{ MAX_FILE_SIZE / (1024 * 1024) }}MB per file, {{ MAX_TOTAL_SIZE / (1024 * 1024) }}MB total
                    </p>
                  </div>

                  <div class="selected-files" *ngIf="selectedFiles().length > 0">
                    <div class="file-item" *ngFor="let file of selectedFiles(); let i = index">
                      <div class="file-info">
                        <i class="pi pi-file file-icon"></i>
                        <div class="file-details">
                          <span class="file-name">{{ file.file.name }}</span>
                          <span class="file-size">{{ file.size }}</span>
                        </div>
                      </div>
                      <div class="file-actions">
                        <p-chip
                          *ngIf="file.error"
                          [label]="'Error'"
                          icon="pi pi-exclamation-triangle"
                          styleClass="p-chip-danger"
                        />
                        <p-button
                          icon="pi pi-times"
                          [text]="true"
                          [rounded]="true"
                          severity="danger"
                          (onClick)="removeFile(i, fileUpload)"
                          [disabled]="isUploading()"
                        />
                      </div>
                    </div>

                    <p-divider />

                    <div class="files-summary">
                      <span class="summary-item">
                        <i class="pi pi-file"></i>
                        {{ selectedFiles().length }} file(s)
                      </span>
                      <span class="summary-item">
                        <i class="pi pi-database"></i>
                        Total: {{ totalSize() }}
                      </span>
                    </div>
                  </div>
                </ng-template>
              </p-fileUpload>

              <!-- Upload Error Message -->
              <p-message
                *ngIf="uploadError()"
                severity="error"
                [text]="uploadError()!"
                styleClass="mt-3"
              />
            </div>
          </p-card>
        </div>

        <!-- Right Column - Deck Metadata -->
        <div class="col-12 lg:col-6">
          <p-card header="Deck Information" [style]="{'height': '100%'}">
            <div class="metadata-form">
              <!-- Title -->
              <div class="field">
                <label for="title" class="form-label required">
                  <i class="pi pi-bookmark"></i>
                  Title
                </label>
                <input
                  pInputText
                  id="title"
                  formControlName="title"
                  placeholder="e.g., Biology 101 - Cell Structure"
                  class="w-full"
                />
                <small
                  class="form-error"
                  *ngIf="uploadForm.get('title')?.invalid && uploadForm.get('title')?.touched"
                >
                  Title is required (3-100 characters)
                </small>
              </div>

              <!-- Description -->
              <div class="field">
                <label for="description" class="form-label">
                  <i class="pi pi-align-left"></i>
                  Description
                </label>
                <textarea
                  pTextarea
                  id="description"
                  formControlName="description"
                  placeholder="Brief description of the deck contents (optional)"
                  rows="3"
                  class="w-full"
                ></textarea>
                <small class="form-hint">
                  {{ uploadForm.get('description')?.value?.length || 0 }} / 500 characters
                </small>
              </div>

              <!-- Category -->
              <div class="field">
                <label for="category" class="form-label required">
                  <i class="pi pi-tags"></i>
                  Category
                </label>
                <p-select
                  id="category"
                  formControlName="category"
                  [options]="categoryOptions"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Select a category"
                  class="w-full"
                >
                  <ng-template let-option pTemplate="item">
                    <div class="option-item">
                      <i [class]="'pi ' + option.icon"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
                <small
                  class="form-error"
                  *ngIf="uploadForm.get('category')?.invalid && uploadForm.get('category')?.touched"
                >
                  Category is required
                </small>
              </div>

              <!-- Difficulty -->
              <div class="field">
                <label for="difficulty" class="form-label required">
                  <i class="pi pi-star"></i>
                  Difficulty Level
                </label>
                <p-select
                  id="difficulty"
                  formControlName="difficulty"
                  [options]="difficultyOptions"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Select difficulty level"
                  class="w-full"
                >
                  <ng-template let-option pTemplate="item">
                    <div class="option-item">
                      <i [class]="'pi ' + option.icon"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
                <small
                  class="form-error"
                  *ngIf="uploadForm.get('difficulty')?.invalid && uploadForm.get('difficulty')?.touched"
                >
                  Difficulty level is required
                </small>
              </div>
            </div>
          </p-card>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="submit-section">
        <p-button
          type="button"
          label="Cancel"
          icon="pi pi-times"
          severity="secondary"
          [text]="true"
          (onClick)="backToDecks()"
        />
        <p-button
          type="submit"
          label="Generate Flashcards"
          icon="pi pi-sparkles"
          [disabled]="!isFormValid()"
          [loading]="isUploading()"
        />
      </div>
    </form>
  </div>

  <!-- Upload Progress -->
  <div class="upload-progress-container" *ngIf="isUploading()">
    <p-card>
      <div class="progress-content">
        <div class="progress-header">
          <i class="pi pi-cloud-upload progress-icon"></i>
          <h2>Uploading Documents...</h2>
        </div>
        <p-progressBar [value]="uploadProgress()" [showValue]="true" />
        <p class="progress-text">
          Please wait while we upload your documents. This may take a few moments.
        </p>
      </div>
    </p-card>
  </div>

  <!-- Processing Status -->
  <div class="processing-container" *ngIf="uploadSuccess() && !isUploading()">
    <p-card>
      <div class="success-content">
        <!-- Success Header -->
        <div class="success-header">
          <i class="pi pi-check-circle success-icon"></i>
          <h2>Upload Successful!</h2>
          <p>Your documents are being processed. AI is generating flashcards...</p>
        </div>

        <!-- Document Processing Status -->
        <div class="processing-status" *ngIf="processingStatuses().length > 0">
          <h3 class="status-title">
            <i class="pi pi-file"></i>
            Document Processing Status
          </h3>

          <div class="status-list">
            <div class="status-item" *ngFor="let status of processingStatuses()">
              <div class="status-info">
                <i [class]="'pi ' + getStatusIcon(status.status)" [ngClass]="{'spinning': status.status === 'processing'}"></i>
                <div class="status-details">
                  <span class="status-filename">{{ status.filename }}</span>
                  <div class="status-meta">
                    <p-chip
                      [label]="status.status"
                      [styleClass]="'status-badge status-' + status.status"
                    />
                    <span *ngIf="status.cards_generated" class="cards-count">
                      <i class="pi pi-file"></i>
                      {{ status.cards_generated }} cards
                    </span>
                  </div>
                </div>
              </div>
              <p-progressBar
                *ngIf="status.status === 'processing'"
                [value]="status.progress"
                [showValue]="false"
                styleClass="status-progress"
              />
              <small *ngIf="status.error_message" class="status-error">
                {{ status.error_message }}
              </small>
            </div>
          </div>

          <!-- Processing Spinner -->
          <div class="processing-spinner" *ngIf="isPolling()">
            <p-progressSpinner
              [style]="{'width': '50px', 'height': '50px'}"
              strokeWidth="4"
            />
            <p>Processing documents...</p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="success-actions" *ngIf="allProcessingComplete()">
          <p-button
            label="View Deck"
            icon="pi pi-eye"
            severity="success"
            (onClick)="viewDeck()"
          />
          <p-button
            label="Upload Another"
            icon="pi pi-plus"
            severity="secondary"
            [text]="true"
            (onClick)="uploadAnother()"
          />
          <p-button
            label="Back to Decks"
            icon="pi pi-arrow-left"
            severity="secondary"
            [text]="true"
            (onClick)="backToDecks()"
          />
        </div>
      </div>
    </p-card>
  </div>
</div>
